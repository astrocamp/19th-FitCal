{% extends "layouts/default.html" %} {% block main %}
<!-- 店家資訊區塊 -->
<div class="flex flex-col mt-5 mb-9 sm:flex-row items-start sm:items-center gap-4">
  <!-- LOGO -->
  <img src="{{ cart.store.logo_url|default:'https://fakeimg.pl/50x50/' }}" alt="店家 Logo" class="w-24 h-24 rounded-lg object-cover border" />

  <!-- 商家詳細資訊 -->
  <div class="space-y-1">
    <div class="flex items-center gap-2 text-xl font-bold">
      <span>{{ cart.store.name }}</span>
    </div>
    <div class="text-sm text-gray-600">營業時間：{{ cart.store.opening_time }}<span>~</span>{{ cart.store.closing_time }}</div>
    <div class="text-sm text-gray-600">
      <span>距離：2.1 公里</span>　｜　 <a href="https://www.google.com/maps/search/?api=1&query={{ cart.store.name|urlencode }}+near+" class="font-bold text-blue-600 hover:underline">{{ cart.store.address }}</a>　｜　 📞
      <a href="tel:{{ cart.store.phone_number|cut:'-' }}" class="font-bold text-blue-600 hover:underline">{{ cart.store.phone_number }}</a>
    </div>
  </div>
</div>

<!-- 商品明細 -->
<div class="space-y-4">
  {% for item in cart_item %}
  <div id="cart-item-{{ item.id }}" x-data="cartItem({{ item.quantity }}, '{{ item.id }}', '{% url 'carts:update_cart_item' item.id %}', {{ item.product.quantity }})" class="flex flex-col md:flex-row md:items-center md:justify-between border rounded-lg p-4 space-y-4 md:space-y-0 md:space-x-4">
    <!-- 商品圖片 -->
    <div class="flex-shrink-0 self-center md:self-auto">
      {% if item.product.image %}
      <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-24 h-24 object-cover rounded-md border border-gray-200" />
      {% else %}
      <div class="w-24 h-24 bg-gray-100 flex items-center justify-center text-gray-400 text-sm rounded-md border">無圖片</div>
      {% endif %}
    </div>

    <!-- 商品資訊與互動 -->
    <div class="flex flex-1 flex-col md:flex-row md:items-center md:justify-between w-full space-y-2 md:space-y-0">
      <!-- 商品名稱與價格 -->
      <div class="text-center md:text-left">
        <p class="text-lg font-medium">{{ item.product.name }}</p>
        <p class="text-gray-600 mt-1">$ {{ item.product.price }}</p>
      </div>

      <!-- 數量與刪除 -->
      <div class="flex items-center justify-end space-x-4 gap-5 w-full md:w-auto">
        <!-- 數量 -->
        <label for="{{ item.id }}_edit_qty" class="sr-only">數量</label>
        <div>
          <input id="{{ item.id }}_edit_qty" type="number" min="1" x-model.number="qty" @blur="isDelete" @keydown.enter.prevent="isDelete"
          class="w-20 border rounded-md px-2 py-1 text-center" />
          <span class="text-gray-600">件</span>
        </div>

        <!-- 刪除按鈕 -->
        <form action="{% url 'carts:delete_cart_item' item.id %}" method="post" onsubmit="return confirm('確認刪除商品？')">
          {% csrf_token %}
          <button type="submit" class="text-red-600 hover:text-red-700 text-2xl transition-colors">
            <i class="fas fa-trash"></i>
          </button>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- 總金額區塊 -->
<div class="mt-8 flex flex-col md:flex-row md:items-center md:justify-between">
  <div class="text-lg font-semibold text-right md:text-left mb-4 md:mb-0">
    總金額：<span id="totalPrice">{{ cart.calculate_total_price }}</span> 元
  </div>

  <!-- Alpine 包裹區塊 -->
  <div x-data="{
    proceedCheckout() {
      // 觸發所有 input 的 blur
      document.querySelectorAll('input[id$=_edit_qty]').forEach(input => input.blur());

      // 稍等 300ms 再跳轉
      setTimeout(() => {
        window.location.href = '{% url "orders:new" %}?cart_id={{ cart.id }}';
      }, 300);
    }
  }">
    <button @click="proceedCheckout"
      class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-lg shadow-md">
      結帳
    </button>
  </div>
</div>
{% endblock main %}
