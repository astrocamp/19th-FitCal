{% extends "layouts/default.html" %} {% block main %}
<!-- åº—å®¶è³‡è¨Šå€å¡Š -->
<div class="flex flex-col mt-5 mb-9 sm:flex-row items-start sm:items-center gap-4">
  <!-- LOGO -->
  <img src="{{ cart.store.logo_url|default:'https://fakeimg.pl/50x50/' }}" alt="åº—å®¶ Logo" class="w-24 h-24 rounded-lg object-cover border" />

  <!-- å•†å®¶è©³ç´°è³‡è¨Š -->
  <div class="space-y-1">
    <div class="flex items-center gap-2 text-xl font-bold">
      <span>{{ cart.store.name }}</span>
    </div>
    <div class="text-sm text-gray-600">ç‡Ÿæ¥­æ™‚é–“ï¼š{{ cart.store.opening_time }}<span>~</span>{{ cart.store.closing_time }}</div>
    <div class="text-sm text-gray-600">
      <span>è·é›¢ï¼š2.1 å…¬é‡Œ</span>ã€€ï½œã€€ <a href="https://www.google.com/maps/search/?api=1&query={{ cart.store.name|urlencode }}+near+" class="font-bold text-blue-600 hover:underline">{{ cart.store.address }}</a>ã€€ï½œã€€ ğŸ“
      <a href="tel:{{ cart.store.phone_number|cut:'-' }}" class="font-bold text-blue-600 hover:underline">{{ cart.store.phone_number }}</a>
    </div>
  </div>
</div>

<!-- å•†å“æ˜ç´° -->
<div class="space-y-4">
  {% for item in cart_item %}
  <div id="cart-item-{{ item.id }}" x-data="cartItem({{ item.quantity }}, '{{ item.id }}', '{% url 'carts:update_cart_item' item.id %}', {{ item.product.quantity }})" class="flex items-center gap-4 border rounded-lg p-3 sm:p-4">
    <!-- å•†å“åœ–ç‰‡ -->
    <div class="flex-shrink-0">
      {% if item.product.image %}
      <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-20 h-20 object-cover rounded-md border border-gray-200" />
      {% else %}
      <div class="w-20 h-20 bg-gray-100 flex items-center justify-center text-gray-400 text-sm rounded-md border">ç„¡åœ–ç‰‡</div>
      {% endif %}
    </div>

    <!-- å³å´å…§å®¹ï¼ˆå•†å“è³‡è¨Š + æ§åˆ¶å€ï¼‰ -->
    <div class="flex flex-1 flex-col justify-between w-full">
      <div class="flex justify-between items-start flex-wrap sm:flex-nowrap">
        <!-- å•†å“è³‡è¨Š -->
        <div class="text-sm">
          <p class="font-medium text-gray-900">{{ item.product.name }}</p>
          <p class="text-gray-500 text-xs">{{ item.product.calories }} kcal</p>
          <p class="text-gray-600 text-sm">$ {{ item.product.price }}</p>
        </div>

        <!-- æ•¸é‡èˆ‡åˆªé™¤ -->
        <div class="flex items-center gap-3 mt-2 sm:mt-0">
          <label for="{{ item.id }}_edit_qty" class="sr-only">æ•¸é‡</label>
          <div class="flex items-center gap-1">
            <input id="{{ item.id }}_edit_qty" type="number" min="1" x-model.number="qty" @blur="isDelete" @keydown.enter.prevent="isDelete" class="w-16 border rounded-md px-2 py-1 text-center text-sm" />
            <span class="text-gray-500 text-xs">ä»¶</span>
          </div>

          <!-- åˆªé™¤æŒ‰éˆ• -->
          <form action="{% url 'carts:delete_cart_item' item.id %}" method="post" onsubmit="return confirm('ç¢ºèªåˆªé™¤å•†å“ï¼Ÿ')">
            {% csrf_token %}
            <button type="submit" class="text-red-600 hover:text-red-700 text-xl transition-colors">
              <i class="fas fa-trash"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- ç¸½å¡è·¯é‡Œã€ç¸½é‡‘é¡å€å¡Š -->
<div class="mt-8 flex justify-between md:items-center">
  <div class="text-lg font-semibold md:text-left mb-4 md:mb-0">
    <p>ç¸½å¡è·¯é‡Œï¼š<span id="totalCalories">{{ cart.total_calories }}</span> kcal</p>
    <p>ç¸½é‡‘é¡ï¼š<span id="totalPrice">{{ cart.total_price }}</span> å…ƒ</p>
  </div>

  <!-- Alpine åŒ…è£¹å€å¡Š -->
  <div
    x-data="{
    proceedCheckout() {
      // è§¸ç™¼æ‰€æœ‰ input çš„ blur
      document.querySelectorAll('input[id$=_edit_qty]').forEach(input => input.blur());

      // ç¨ç­‰ 300ms å†è·³è½‰
      setTimeout(() => {
        window.location.href = '{% url 'orders:new' %}?cart_id={{ cart.id }}';
      }, 300);
    }
  }"
  >
    <button @click="proceedCheckout" class="bg-[#5a855a] hover:bg-[#2e4e2e] text-white px-6 py-2 rounded-lg text-lg shadow-md">çµå¸³</button>
  </div>
</div>
{% endblock main %}
